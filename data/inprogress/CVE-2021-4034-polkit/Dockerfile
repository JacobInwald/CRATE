#syntax=docker/dockerfile:1
FROM debian:bullseye-slim
WORKDIR /home/


# Install core dependencies
RUN apt-get -y update && apt-get -y install --no-install-recommends \ 
    git \
    cmake \
    build-essential \
    libxml2-dev \
    sudo \ 
    zsh \
    meson \
    ninja-build \
    wget \
    ca-certificates


# ----------------- SETUP SOURCE ---------------

# Install source code dependencies
RUN apt-get -y install \
  pkg-config libglib2.0-dev libexpat1-dev libpam0g-dev \
  libgirepository1.0-dev intltool automake

# Add source code 
RUN wget https://www.freedesktop.org/software/polkit/releases/polkit-0.99.tar.gz && \
  tar -xvf polkit-0.99.tar.gz && \
  rm *.tar.gz && \
  mv polkit-0.99 polkit

RUN cd polkit && \
  ./configure --prefix=/usr --sysconfdir=/etc --localstatedir=/var && \
  make -j64 && \
  sudo make install

# Instrument build file to allow for hardening culpable file
# RUN ...

# ------------- ADD EXPLOIT -------------

RUN useradd -m user
USER user
RUN mkdir /home/user/exploit
ADD Makefile.exploit /home/user/exploit/Makefile
ADD *.c /home/user/exploit/
RUN cd /home/user/exploit && \
  make all

RUN git clone https://github.com/PeterGottesman/pwnkit-exploit /home/user/exploit-2
  # su user -c "make all"
USER root
# ---------------- ADD DEMO ----------------
ADD demo-exploit.sh ./
RUN chmod +x demo-exploit.sh
ENV HARDEN_FLAGS=""
