#syntax=docker/dockerfile:1
FROM debian:bullseye-slim
WORKDIR /home/


# Install core dependencies
RUN apt-get -y update && apt-get -y install --no-install-recommends \ 
    git \
    cmake \
    build-essential \
    libxml2-dev \
    sudo \ 
    zsh \
    meson \
    ninja-build \
    wget \
    ca-certificates


# ----------------- SETUP SOURCE ---------------

# Install source code dependencies
RUN apt-get -y install \ 
    pkg-config \
    libevent-dev \
    libssl-dev 


# Add source code 
RUN wget https://github.com/OpenSMTPD/OpenSMTPD/archive/refs/tags/6.6.0p1.tar.gz && \
  tar -xvf 6.6.0p1.tar.gz && \
  mv OpenSMTPD-6.6.0p1/ opensmtpd && \
  rm 6.6.0p1.tar.gz

# Instrument build file to allow for hardening culpable file
# RUN ...

# ------------- ADD EXPLOIT -------------

RUN apt-get -y install gnupg2

RUN wget https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb && \
  mv msfupdate.erb msfinstall && \
  chmod 755 msfinstall && \
  ./msfinstall

RUN useradd -m user && \
  su user -c "msfdb init"

ADD exploit.rb /home/user/.msf4/modules/exploits/test/exploit.rb 
ADD exploit.rb ./ 

# ---------------- ADD DEMO ----------------
ADD demo-exploit.sh ./
RUN chmod +x demo-exploit.sh
ENV HARDEN_FLAGS=""
