#syntax=docker/dockerfile:1
FROM debian:bullseye-slim
WORKDIR /home/


# Install core dependencies
RUN apt-get -y update && apt-get -y install --no-install-recommends \ 
    git \
    cmake \
    build-essential \
    libxml2-dev \
    sudo \ 
    zsh \
    meson \
    ninja-build \
    wget \
    ca-certificates


# ----------------- SETUP SOURCE ---------------

# Install source code dependencies
RUN apt-get -y install \ 
    pkg-config \
    libevent-dev \
    libssl-dev 


# Add source code 
RUN wget https://github.com/OpenSMTPD/OpenSMTPD/archive/refs/tags/6.6.0p1.tar.gz && \
  tar -xvf 6.6.0p1.tar.gz && \
  mv OpenSMTPD-6.6.0p1/ opensmtpd && \
  rm 6.6.0p1.tar.gz

# Instrument build file to allow for hardening culpable file
# RUN ...

# ------------- ADD EXPLOIT -------------

# Install python 2.7 support for the exploit
ARG PYPY_VERSION=2.7-v7.3.17
ARG PYPY_ROOT=pypy$PYPY_VERSION-linux64
ARG PYPY_URL=https://downloads.python.org/pypy/$PYPY_ROOT.tar.bz2

# Install pypy itself under /opt and symlink the pypy2 binary into
# /usr/local/bin so that it appears on the PATH.
RUN    cd /opt \
    && wget "${PYPY_URL}" | tar -xjf - \
    && ln -s "/opt/${PYPY_ROOT}/bin/pypy2" /usr/local/bin/pypy2

# RUN apt-get -y install \
#     python3 \
#     python3-pip

ADD exploit.py ./

# ---------------- ADD DEMO ----------------
ADD demo-exploit.sh ./
RUN chmod +x demo-exploit.sh
ENV HARDEN_FLAGS=""
