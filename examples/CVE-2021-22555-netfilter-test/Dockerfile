#syntax=docker/dockerfile:1
FROM debian:bullseye-slim
WORKDIR /home/


# Install core dependencies
RUN apt-get -y update && apt-get -y install --no-install-recommends \ 
    git \
    cmake \
    build-essential \
    libxml2-dev \
    sudo \ 
    zsh \
    meson \
    ninja-build \
    wget \
    ca-certificates


# ----------------- SETUP SOURCE ---------------

# Install source code dependencies
RUN apt-get -y install \
  libncurses-dev \
  flex \ 
  bison \
  libssl-dev \
  bc \
  libelf-dev 


RUN mkdir linux && \
    cd linux && \
    git init && \
    git remote add focal git://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux/+git/focal

RUN cd linux && \
  git fetch focal 

RUN cd linux && \
  git checkout hwe-5.8 && \
  git pull 

RUN apt-get install -y \
  kernel-wedge \
  rsync \
  cpio \
  fakeroot \
  curl \
  gawk \
  dkms

RUN cd linux &&  \
  debian/rules clean && \
  debian/rules genconfigs && \
  cp CONFIGS/amd64-config.flavour.generic .config && \
  make bzImage -j 8 && \ 
  CONFIG_MODULE_SIG=n make -C . M=net

# Instrument build file to allow for hardening culpable file
# ADD Makefile.patch ./
# RUN patch linux/net/netfilter/Makefile Makefile.patch


# ------------- SETUP EMULATION -------------
# Install dependencies
RUN apt-get -y install \
  qemu-utils \
  qemu-system-x86 \
  qemu-system-gui \
  qemu-user \
  libc6-dev-i386 

# Use buzybox to build a minimal initramfs, ad  d the exploit and then package it up.
ENV BUSYVER="1.34.1"
RUN wget https://busybox.net/downloads/busybox-${BUSYVER}.tar.bz2 && \
  tar xf busybox-${BUSYVER}.tar.bz2 && \
  rm -f busybox-${BUSYVER}.tar.bz2 && \
  mv busybox-${BUSYVER} busybox

# Add in busy box config (builds as static)
ADD busybox.config busybox/.config

# Build busybox
RUN cd busybox && \
  make -j 8 && \
  make install 

# --------------- SETUP INITRAMFS -----------
# Add init script
ADD init ./busybox/_install/init

# Add demo exploit 
ADD vm-demo-exploit.sh ./busybox/_install/exploit

# Add and build exploit
ADD exploit.c ./
RUN gcc -m32 -static -o exploit exploit.c && \
  mkdir busybox/_install/home && \
  mv exploit busybox/_install/home 

# Add net modules
RUN cd linux/net && \
  mkdir -p /home/busybox/_install/lib/modules/5.8.18+/kernel/net && \
  cp -dpvr . /home/busybox/_install/lib/modules/5.8.18+/kernel/net && \
  find /home/busybox/_install/lib/modules/5.8.18+/kernel/net -type f  ! -name "*.ko" -delete

RUN  cd /home/linux && \
  find /home/busybox/_install/lib/modules/5.8.18+/kernel/net -type f -name "*.ko" -exec ./scripts/sign-file sha512 ./certs/signing_key.pem ./certs/signing_key.x509 {} \;
# Organise root file strcuture
# Package up the initramfs
RUN cd busybox/_install && \
  mkdir -p proc sys dev etc etc/init.d && \
  chmod +x init && \
  find . -print0 | cpio --null -ov --format=newc > /home/initramfs

# ---------------- ADD DEMO ----------------
ADD demo-exploit.sh ./
RUN chmod +x demo-exploit.sh
ENV HARDEN_FLAGS=""
